<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Task View</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container mt-3">
    <h1 th:text="'Task: ' + ${dir_name}">Task Name</h1>
    <div th:if="${dir_name != null}">
        <iframe
                height="600px"
                loading="lazy"
                th:src="@{/pdf/{dir_name}(dir_name=${dir_name})}"
                title="PDF-file"
                width="60%"
        ></iframe>
    </div>
    <div id="task-details">
        <h2>Details</h2>
        <div>
            <p><strong>Status:</strong> <span th:text="${status}">Status</span></p>
            <div th:if="${attempts.size() > 0}">
                <h3>Previous Solutions</h3>
                <table class="table">
                    <thead>
                    <tr>
                        <th>Status</th>
                        <th>Solution</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="attempt : ${attempts}">
                        <td th:text="${attempt.response.status}">Status</td>
                        <td>
                            <a th:href="@{'/solution/' + ${attempt.solutionPath}}" th:text="'Download'">Download</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="chatContent">
        <div id="chat-page">
            <div id="chat-window">
                <div id="messages" style="height:300px; overflow-y:scroll; border: 1px solid #ccc;">
                </div>
                <input id="messageInput" placeholder="Type your message..." type="text">
                <button id="sendButton">Send</button>
            </div>
        </div>
        <script th:inline="javascript">
            /*<![CDATA[*/
            var stompClient = null;
            var chatId = [[${chatId}]];
            var username = 'admin';

            function connect() {
                var socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/topic/publicChatRoom/' + chatId, function (message) {
                        showMessage(JSON.parse(message.body));
                    });
                    loadHistory(chatId);
                }, function (error) {
                    console.log('Error in connection: ', error);
                });
            }

            function sendMessage() {
                if (typeof stompClient !== 'undefined' && stompClient.connected) {
                    var messageToSend = {
                        username: username,
                        content: $("#messageInput").val(),
                        chatId: chatId.toString()
                    };
                    console.log('Sending message: ', messageToSend);
                    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(messageToSend));
                    $('#messageInput').val("");
                } else {
                    console.log("WebSocket connection is not established.");
                }
            }

            function showMessage(message) {
                var messageElement = document.createElement('div');
                messageElement.innerHTML = "<strong>" + message.username + ":</strong> " + message.content;
                document.getElementById("messages").appendChild(messageElement);
            }

            function loadHistory(chatId) {
                $.get("/chat/history/" + chatId, function (messages) {
                    console.log('History loaded: ', messages);
                    messages.forEach(function (message) {
                        showMessage(message);
                    });
                }).fail(function (error) {
                    console.error("Error loading history: ", error);
                });
            }

            $(document).ready(function () {
                connect();
                $("#sendButton").click(function () {
                    sendMessage();
                });
            });
            /*]]>*/
        </script>
    </div>
</div>
</body>
</html>
