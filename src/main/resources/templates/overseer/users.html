<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-3">
    <h1>User Management</h1>
    <button class="btn btn-success" onclick="showCreateUserModal()">Create User</button>
    <table class="table mt-3">
        <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Groups</th>
            <th>Email</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users}">
            <td th:text="${user.id}"></td>
            <td th:text="${user.username}"></td>
            <td th:text="${user.role}"></td>
            <td>
                <ul>
                    <li th:each="groupId : ${user.groupIds}">
                        <span th:each="group : ${groups}" th:if="${group.id == groupId}" th:text="${group.name}"></span>
                    </li>
                </ul>
            </td>
            <td th:text="${user.email}"></td>
            <td>
                <button class="btn btn-primary" th:attr="onclick='showEditUserModal(' + ${user.id} + ');'">Edit</button>
                <button class="btn btn-danger" th:attr="onclick='deleteUser(' + ${user.id} + ');'">Delete</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Create/Edit User Modal -->
<div class="modal" id="userModal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="userForm" method="post" th:action="@{/overseer/users/create}">
                <div class="modal-header">
                    <h5 class="modal-title">Create/Edit User</h5>
                    <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="userId" name="id" type="hidden">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input class="form-control" id="username" name="username" required type="text">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input class="form-control" id="password" name="password" required type="password">
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select class="form-control" id="role" name="role" required>
                            <option value="STUDENT">STUDENT</option>
                            <option value="TEACHER">TEACHER</option>
                            <option value="OVERSEER">OVERSEER</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input class="form-control" id="email" name="email" type="email">
                    </div>
                    <div class="form-group">
                        <label for="groups">Groups</label>
                        <select class="form-control" id="groups" multiple name="groupIds">
                            <option th:each="group : ${groups}" th:text="${group.name}" th:value="${group.id}"></option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Save</button>
                    <button class="btn btn-secondary" data-dismiss="modal" type="button">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let users = /*[[${users}]]*/ [];
    /*]]>*/
</script>

<script>
    function showCreateUserModal() {
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('userForm').action = '/overseer/users/create';
        $('#userModal').modal('show');
    }

    function showEditUserModal(userId) {
        console.log('All users:', users);
        console.log('User ID to edit:', userId);

        let user = users.find(u => u.id === userId);
        if (!user) {
            console.error('User not found:', userId);
            return;
        }

        document.getElementById('userId').value = user.id;
        document.getElementById('username').value = user.username;
        document.getElementById('password').value = '';
        document.getElementById('role').value = user.role;
        document.getElementById('email').value = user.email;
        let groupsSelect = document.getElementById('groups');
        Array.from(groupsSelect.options).forEach(option => {
            option.selected = user.groupIds.includes(parseInt(option.value));
        });
        document.getElementById('userForm').action = '/overseer/users/update';
        $('#userModal').modal('show');
    }

    function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            $.post('/overseer/users/delete', {userId: userId})
                .done(function () {
                    location.reload();
                });
        }
    }
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>
